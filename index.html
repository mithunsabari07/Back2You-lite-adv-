<!DOCTYPE html>
<html>
<head>
  <title>Back2You</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    /* CSS STYLING */
    body { font-family: sans-serif; background: #f4f6f8; padding: 20px; max-width: 600px; margin: 0 auto; }
    h2, h3 { text-align: center; color: #333; margin-top: 20px; }
    
    /* Input & Button Styles */
    input, select, button {
      width: 100%; padding: 12px; margin: 6px 0;
      border: 1px solid #ddd; border-radius: 8px;
      box-sizing: border-box; font-size: 16px;
    }
    button { color: white; border: none; font-weight: bold; cursor: pointer; transition: 0.2s; }
    button:hover { opacity: 0.9; }
    
    /* Action Buttons */
    .btn-delete { background: #ff4444; width: 48%; font-size: 14px; padding: 8px; }
    .btn-edit { background: #ffbb33; color: black; width: 48%; font-size: 14px; padding: 8px; margin-right: 2%; }
    
    /* Post Buttons */
    .btn-lost { background: #dc3545; }
    .btn-found { background: #28a745; }
    
    /* EXPAND BARS */
    .bar-lost { 
        background: #dc3545; margin-top: 30px; padding: 15px; font-size: 18px; border-radius: 8px;
        text-align: left; width: 100%; display: flex; justify-content: space-between; align-items: center;
    }
    .bar-found { 
        background: #28a745; margin-top: 15px; padding: 15px; font-size: 18px; border-radius: 8px;
        text-align: left; width: 100%; display: flex; justify-content: space-between; align-items: center;
    }

    /* Card Styles */
    .card { background: white; padding: 15px; margin-top: 15px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
    .lost-card { border-left: 5px solid #ff4444; }
    .found-card { border-left: 5px solid #28a745; }

    /* Image Preview Style */
    .item-img {
        width: 100%; max-height: 250px; object-fit: contain;
        border-radius: 5px; margin-top: 10px; background: #f0f0f0; border: 1px solid #ccc;
    }
    
    .actions { margin-top: 10px; display: flex; }
    
    /* Hidden List Containers */
    #lostContainer, #foundContainer { 
        display: none; background: #fff0f0; padding: 10px; 
        border-radius: 0 0 8px 8px; margin-bottom: 20px;
    }
    #foundContainer { background: #f0fff4; }

    /* Search Input Style */
    .search-bar { border: 2px solid #ccc; background: #fff; margin-bottom: 10px; }
    
    /* ‚ú® SEARCH HIGHLIGHT COLOR */
    mark { background-color: yellow; color: black; border-radius: 3px; padding: 0 2px; }
  </style>
</head>
<body>

  <h2>Back2You Lite</h2>

  <div id="appArea">
    
    <div class="card lost-card">
      <h3 style="color:#dc3545; margin-top:0;">üî¥ Report Lost Item</h3>
      <input id="lName" placeholder="üë§ Your Name">
      <input id="lItem" placeholder="üì¶ What did you lose?">
      <input id="lLoc" placeholder="üìç Where?">
      <input id="lContact" placeholder="üìû Contact Info">
      <button class="btn-lost" onclick="addLostItem()">Post Lost Report</button>
    </div>

    <div class="card found-card">
      <h3 style="color:#28a745; margin-top:0;">üü¢ Report Found Item</h3>
      <input id="fName" placeholder="üë§ Your Name">
      <input id="fItem" placeholder="üì¶ What did you find?">
      <input id="fLoc" placeholder="üìç Where?">
      <input id="fContact" placeholder="üìû Contact Info">
      
      <label style="font-size:14px; color:#555; display:block; margin-top:10px;">üì∏ Upload Photo (Max 1MB):</label>
      <input type="file" id="fImage" accept="image/*">

      <button class="btn-found" id="foundBtn" onclick="addFoundItem()">Post Found Report</button>
    </div>

    <hr style="margin:30px 0; border:0; border-top:1px solid #ccc;">

    <button class="bar-lost" onclick="toggleSection('lostContainer')">
        <span>üî¥ View Lost Items</span>
        <span>‚ñº</span>
    </button>
    
    <div id="lostContainer">
        <input class="search-bar" id="searchLost" placeholder="üîç Search Lost Items..." onkeyup="filterList('lost')">
        <div id="lostList">Loading...</div>
    </div>

    <button class="bar-found" onclick="toggleSection('foundContainer')">
        <span>üü¢ View Found Items</span>
        <span>‚ñº</span>
    </button>

    <div id="foundContainer">
        <input class="search-bar" id="searchFound" placeholder="üîç Search Found Items..." onkeyup="filterList('found')">
        <div id="foundList">Loading...</div>
    </div>

  </div>

  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>

  <script>
    // --- 1. CONFIGURATION ---
    const firebaseConfig = {
      apiKey: "AIzaSyDKy_RM1zrJS2Ux-mrf-ZSAFG3QJGSvm_c",
      authDomain: "back2you-lite-e6695.firebaseapp.com",
      projectId: "back2you-lite-e6695"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();
    let currentUser = null;
    let allItems = []; 

    auth.signInAnonymously().catch(e => console.log(e));

    auth.onAuthStateChanged(user => {
      if (user) {
        currentUser = user;
        renderList();
      }
    });

    // --- 2. FUZZY SEARCH & HIGHLIGHT LOGIC ---
    
    function fuzzy(q, t) {
      if(!q) return true; 
      q = q.toLowerCase(); 
      t = (t || "").toLowerCase();
      let i = 0;
      for (let c of t) if (c === q[i]) i++;
      return i === q.length;
    }

    function highlight(text, search) {
        if (!search || !text) return text;
        const regex = new RegExp(`(${search})`, 'gi');
        return text.replace(regex, '<mark>$1</mark>');
    }

    // --- 3. TOGGLE FUNCTION ---
    function toggleSection(id) {
        const container = document.getElementById(id);
        
        if (container.style.display === "block") {
            container.style.display = "none";
        } else {
            document.getElementById('lostContainer').style.display = 'none';
            document.getElementById('foundContainer').style.display = 'none';
            container.style.display = "block";
            setTimeout(() => {
                container.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }, 100);
        }
    }

    // --- 4. ADD FUNCTIONS ---
    function addLostItem() {
      saveToDb("lost", "lName", "lItem", "lLoc", "lContact", null, null);
    }

    function addFoundItem() {
      const fileInput = document.getElementById("fImage");
      const file = fileInput.files[0];
      const btn = document.getElementById("foundBtn");
      
      if (file && file.size > 800000) return alert("File too big! Use a screenshot.");

      if (file) {
          btn.innerText = "Uploading...";
          btn.disabled = true;
          const reader = new FileReader();
          reader.onload = function(e) {
              saveToDb("found", "fName", "fItem", "fLoc", "fContact", e.target.result, btn);
          };
          reader.readAsDataURL(file);
      } else {
          saveToDb("found", "fName", "fItem", "fLoc", "fContact", null, btn);
      }
    }

    function saveToDb(type, idName, idItem, idLoc, idContact, imageBase64, btn) {
      if (!currentUser) return alert("Waiting for connection...");
      
      const nameVal = document.getElementById(idName).value;
      const itemVal = document.getElementById(idItem).value;
      const locVal = document.getElementById(idLoc).value;
      const contactVal = document.getElementById(idContact).value;

      if (!nameVal || !itemVal || !locVal || !contactVal) {
          if(btn) { btn.disabled=false; btn.innerText="Post Found Report"; }
          return alert("Please fill all text fields");
      }

      db.collection("items").add({
        type: type,
        name: nameVal,
        item: itemVal,
        location: locVal,
        contact: contactVal,
        imageUrl: imageBase64, 
        ownerId: currentUser.uid, 
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
      }).then(() => {
        alert("Report Posted!");
        document.getElementById(idName).value = "";
        document.getElementById(idItem).value = "";
        document.getElementById(idLoc).value = "";
        document.getElementById(idContact).value = "";
        if(type==='found') {
            document.getElementById("fImage").value = "";
            btn.innerText = "Post Found Report";
            btn.disabled = false;
        }
      }).catch(err => {
          alert("Error: " + err.message);
          if(btn) { btn.disabled=false; btn.innerText="Post Found Report"; }
      });
    }

    function editItem(id, oldName, oldItem, oldLoc, oldContact) {
        const newName = prompt("Edit Name:", oldName);
        if(newName === null) return; 
        const newItem = prompt("Edit Item:", oldItem);
        const newLoc = prompt("Edit Location:", oldLoc);
        const newContact = prompt("Edit Contact:", oldContact);

        if(newName && newItem && newLoc && newContact) {
            db.collection("items").doc(id).update({
                name: newName, item: newItem, location: newLoc, contact: newContact
            });
        }
    }

    function deleteItem(id) {
      if (confirm("Delete this?")) {
        db.collection("items").doc(id).delete();
      }
    }

    // --- 5. RENDER & SEARCH FUNCTION ---
    function renderList() {
      db.collection("items").orderBy("timestamp", "desc").onSnapshot(snapshot => {
        allItems = [];
        snapshot.forEach(doc => {
            allItems.push({ id: doc.id, ...doc.data() });
        });
        filterList('lost');
        filterList('found');
      });
    }

    function filterList(type) {
        // Get search input
        const searchInput = type === 'lost' ? document.getElementById("searchLost").value : document.getElementById("searchFound").value;
        const listDiv = type === 'lost' ? document.getElementById("lostList") : document.getElementById("foundList");
        
        listDiv.innerHTML = "";

        // Filter using fuzzy logic
        const filtered = allItems.filter(d => 
            d.type === type && (
                fuzzy(searchInput, d.item) || 
                fuzzy(searchInput, d.location) || 
                fuzzy(searchInput, d.name)
            )
        );

        if (filtered.length === 0) {
            listDiv.innerHTML = "<p style='text-align:center; color:#777'>No items found.</p>";
            return;
        }

        filtered.forEach(data => {
            const imageHTML = data.imageUrl ? `<img src="${data.imageUrl}" class="item-img">` : "";
            const cardClass = type === 'lost' ? 'lost-card' : 'found-card';
            
            // Apply Highlight
            const hName = highlight(data.name || "Anonymous", searchInput);
            const hItem = highlight(data.item, searchInput);
            const hLoc = highlight(data.location, searchInput);

            listDiv.innerHTML += `
            <div class="card ${cardClass}">
              üë§ <b>${hName}</b><br>
              üì¶ <strong>${hItem}</strong><br>
              üìç ${hLoc}<br>
              üìû ${data.contact}<br>
              ${imageHTML}
              <div class="actions">
                  <button class="btn-edit" onclick="editItem('${data.id}', '${data.name}', '${data.item}', '${data.location}', '${data.contact}')">‚úèÔ∏è Edit</button>
                  <button class="btn-delete" onclick="deleteItem('${data.id}')">üóëÔ∏è Delete</button>
              </div>
            </div>`;
        });
    }
  </script>

</body>
</html>
